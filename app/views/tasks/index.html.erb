<% content_for(:title, @list.title) %>

<div id="pageContent">
	<div id="centerColumn">
		<div id="listTitleDiv">
			<div id="options">
				<button id="newTaskButton">New</button>
				<%= button_to "Clear Completed", { action: "clearCompleted" }, remote: true, form: { id: "formClearCompleted" } %>

				<div id="importSection">
					<%= form_tag({action: :upload}, multipart: true) do %>
						<%= submit_tag 'Import CSV' %>
						<%= file_field_tag 'csv' %>
						<% if flash[:importCountSucceeded] %>
							<div id="importSectionStatus">Imported <%= pluralize(flash[:importCountSucceeded], 'task') %> successfully. Failed to import <%= pluralize(flash[:importCountFailed], 'tasks') %>.</div>
						<% end %>
					<% end %>
				</div>
			</div>
			<div id="listTitleHeadersSection">
				<div id="listTitleHeaders">
					<% @lists.each do |list| %><!--
						--><div class="listTitleHeader <%= if (list.id == @list.id); 'listTitleHeaderCurrent' end %>">
							<%= link_to(list.title, list, class: 'listTitleHeaderText') %>
							<% if @constrainedList && (list.id == @list.id) %>
								<span class="removeConstraintLink"><%= link_to('[remove constraints]', tasks_path) %></span>
							<% end %>
						</div><!--
					--><% end %><!--
				--></div><!--
				--><div id="listTitleHeaderNew"><%= link_to '+', lists_path, action: 'create', method: 'post', remote: true, id: 'listTitleHeaderNewLink' %></div>
			</div>
		</div>

		<div id="listItems">
			<div id="listHeaders">
				<div class="listItemColumn listItemCheckbox"></div><!--
				--><% if shouldDisplayColumn('task') %><div class="listItemColumn listItemTitle"><%= link_to('Task (0)', tasks_path(sort: 'task')) %></div><% end %><!--
				--><% if shouldDisplayColumn('category') %><div class="listItemColumn listItemCategory"><%= link_to('Category', tasks_path(sort: 'category')) %></div><% end %><!--
				--><% if shouldDisplayColumn('priority') %><div class="listItemColumn listItemPriority"><%= link_to('P', tasks_path(sort: 'priority')) %></div><% end %><!--
				--><% if shouldDisplayColumn('datecreated') %><div class="listItemColumn listItemDateCreated"><%= link_to('Created', tasks_path(sort: 'created')) %></div><% end %><!--
				--><% if shouldDisplayColumn('datestart') %><div class="listItemColumn listItemDateStart"><%= link_to('Start', tasks_path(sort: 'start')) %></div><% end %><!--
				--><% if shouldDisplayColumn('datedue') %><div class="listItemColumn listItemDateDue"><%= link_to('Due', tasks_path(sort: 'due')) %></div><% end %><!--
				--><% if shouldDisplayColumn('underway') %><div class="listItemColumn listItemUnderway"><%= link_to('Underway', tasks_path(sort: 'underway')) %></div><% end %><!--
				--><% if shouldDisplayColumn('blocked') %><div class="listItemColumn listItemBlocked"><%= link_to('Blocked', tasks_path(sort: 'blocked')) %></div><% end %><!--
				--><% if shouldDisplayColumn('location') %><div class="listItemColumn listItemLocation"><%= link_to('Location', tasks_path(sort: 'location')) %></div><% end %><!--
				--><% if shouldDisplayColumn('frequency') %><div class="listItemColumn listItemFrequency"><%= link_to('Frequency', tasks_path(sort: 'frequency')) %></div><% end %><!--
				--><% if shouldDisplayColumn('dependee') %><div class="listItemColumn listItemDependee"><%= link_to('Dependee', tasks_path(sort: 'dependee')) %></div><% end %><!--
				--><% if shouldDisplayColumn('status') %><div class="listItemColumn listItemStatus">Status</div><% end %><!--
				--><div class="listItemColumn listItemDelete"></div>
			</div>

			<% prevTask = nil %>
		    <% @tasks.each do |task| %>

				<% beginNewSectionPriority = @showPriorityHeaders && (!prevTask || (prevTask.priority != task.priority)) %>
				<% beginNewSectionCategory = @showCategoryHeaders && (!prevTask || (prevTask.priority != task.priority) || (prevTask.category_id != task.category_id)) %>
				<% if beginNewSectionCategory && prevTask # End previous category section %>
					</div></div>
				<% end %>
				<% if beginNewSectionPriority %>
					<% if prevTask # End previous priority section %>
						</div></div>
					<% end %>
					<div class="listSectionPriority" data-priority="<%= task.priority %>">
						<div class="listSectionHeader listSectionHeaderPriority" data-priority="<%= task.priority %>">P<%= task.priority %></div>
						<div class="listSectionItems" data-priority="<%= task.priority %>">
				<% end %>
				<% if beginNewSectionCategory %>
					<div class="listSectionCategory" data-category_id="<%= task.category_id %>">
						<div class="listSectionHeader listSectionHeaderCategory" data-priority="<%= task.priority %>" data-category_id="<%= task.category_id %>"><%= task.category_title ? task.category_title : '[no category]' %></div>
						<div class="listSectionItems" data-priority="<%= task.priority %>" data-category_id="<%= task.category_id %>">
				<% end %>

			    <div class="listItem <%= if task.done; 'listItemTaskCompleted' end %>" id="listItem_<%= task.id %>">
				  <div class="listItemColumn listItemCheckbox"><%= check_box("completed", task.id, {checked: task.done, class: 'taskCheckbox', :data => {:remote => true, :url => url_for(:action => 'complete', :id => task.id), :id => task.id, :method => :put}}) %></div><!--
				  --><% if shouldDisplayColumn('task') %><div id="title_<%= task.id %>" class="listItemColumn listItemTitle <%= if task.done; 'taskCompleted' end %>"><%= task.title %></div><% end %><!--
				  --><% if shouldDisplayColumn('category') %><div id="category_<%= task.id %>" class="listItemColumn listItemCategory <%= if task.done; 'taskCompleted' end %>"><%= if task.category_title; link_to(task.category_title, tasks_path(category: task.category_id)) end %></div><% end %><!--
				  --><% if shouldDisplayColumn('priority') %><div id="priority_<%= task.id %>" class="listItemColumn listItemPriority <%= if task.done; 'taskCompleted' end %>"><%= link_to(task.priority, tasks_path(priority: task.priority)) %></div><% end %><!--
				  --><% if shouldDisplayColumn('datecreated') %><div id="datecreated_<%= task.id %>" class="listItemColumn listItemDateCreated <%= if task.done; 'taskCompleted' end %>"><time datetime="<%= task.created_at.strftime("%FT%T%:z") %>"><%= link_to(task.created_at.strftime("%-m/%-d"), tasks_path(created: task.created_at.strftime("%F"))) %></time></div><% end %><!--
				  --><% if shouldDisplayColumn('datestart') %><div id="datestart_<%= task.id %>" class="listItemColumn listItemDateStart <%= if task.done; 'taskCompleted' end %>"><% if task.start; %><time datetime="<%= task.start.strftime("%F") %>"><%= link_to(task.start.strftime("%-m/%-d"), tasks_path(start: task.start.strftime("%F"))) %></time><% end %></div><% end %><!--
				  --><% if shouldDisplayColumn('datedue') %><div id="datedue_<%= task.id %>" class="listItemColumn listItemDateDue <%= if task.done; 'taskCompleted' end %>"><% if task.due; %><time datetime="<%= task.due.strftime("%F") %>"><%= link_to(task.due.strftime("%-m/%-d"), tasks_path(due: task.due.strftime("%F"))) %></time><% end %></div><% end %><!--
				  --><% if shouldDisplayColumn('underway') %><div id="underway_<%= task.id %>" class="listItemColumn listItemUnderway <%= if task.done; 'taskCompleted' end %>"><%= task.underway ? 'Yes' : '' %></div><% end %><!--
				  --><% if shouldDisplayColumn('blocked') %><div id="blocked_<%= task.id %>" class="listItemColumn listItemBlocked <%= if task.done; 'taskCompleted' end %>"><%= task.blocked ? 'Yes' : '' %></div><% end %><!--
				  --><% if shouldDisplayColumn('location') %><div id="location_<%= task.id %>" class="listItemColumn listItemLocation <%= if task.done; 'taskCompleted' end %>"><%= if task.location; link_to(task.location, tasks_path(location: task.location)) end %></div><% end %><!--
				  --><% if shouldDisplayColumn('frequency') %><div id="frequency_<%= task.id %>" class="listItemColumn listItemFrequency <%= if task.done; 'taskCompleted' end %>"><%= link_to(task.frequency, tasks_path(frequency: task.frequency)) %></div><% end %><!--
				  --><% if shouldDisplayColumn('dependee') %><div id="dependee_<%= task.id %>" class="listItemColumn listItemDependee <%= if task.done; 'taskCompleted' end %>"><%= if task.dependee; link_to(task.dependee, tasks_path(dependee: task.dependee)) end %></div><% end %><!--
				  --><% if shouldDisplayColumn('status') %><div id="status_<%= task.id %>" class="listItemColumn listItemStatus <%= if task.done; 'taskCompleted' end %>"><%= task.status %></div><% end %><!--
				  --><div class="listItemColumn listItemDelete"><%= link_to 'X', task_path(task), method: :delete, data: {confirm: 'Are you sure?', :id => task.id}, remote: true, class: 'taskDelete' %></div>
			  	</div>

				<% prevTask = task %>
		    <% end %>

			<% if @showCategoryHeaders && !@tasks.empty? %>
				</div></div>
			<% end %>
			<% if @showPriorityHeaders && !@tasks.empty? %>
				</div></div>
			<% end %>
		</div>
	</div>
</div>

<div id="newTaskDialog" title="New Task">
<%= render 'form' %>
</div>

<% if @reshowNewTaskForm; %>
<script type="text/javascript">
     $(document).ready(function(){ $('#newTaskDialog').dialog('open') });
</script>
<% end %>
